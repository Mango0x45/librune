#!/bin/sh

cache()
{
	name="/tmp/librune/rtype/$(basename "$1")"
	if test ! -f "$name"
	then
		mkdir -p /tmp/librune/rtype
		wget -q "$1" -O "$name"
	fi
}

set -e
cd "${0%/*}/.."
exec >include/internal/rtype/wb.h

readonly URL='https://www.unicode.org/Public/UCD/latest/ucd/auxiliary/WordBreakProperty.txt'
cache "$URL"

cat <<C
/* This file is autogenerated by gen/rtype-wb; DO NOT EDIT. */

#ifndef RUNE_IWBERNAL_RTYPE_WB_H
#define RUNE_INTERNAL_RTYPE_WB_H

/* IWYU pragma: private */
/* clang-format off */

#include "../types.h"
#include "../../rtype.h"
#include "../../rune.h"

static const rprop_wb_bf rtype_wb_lat1_tbl[] = {
C

gawk '
BEGIN {
	FS = "( *#.*| +; +)"
	map["CR"] = "CR"
	map["Double_Quote"] = "DQ"
	map["E_Base"] = "EB"
	map["E_Base_GAZ"] = "EBG"
	map["E_Modifier"] = "EM"
	map["ExtendNumLet"] = "EX"
	map["Extend"] = "EXTEND"
	map["Format"] = "FO"
	map["Glue_After_Zwj"] = "GAZ"
	map["Hebrew_Letter"] = "HL"
	map["Katakana"] = "KA"
	map["ALetter"] = "LE"
	map["LF"] = "LF"
	map["MidNumLet"] = "MB"
	map["MidLetter"] = "ML"
	map["MidNum"] = "MN"
	map["Newline"] = "NL"
	map["Numeric"] = "NU"
	map["Regional_Indicator"] = "RI"
	map["Single_Quote"] = "SQ"
	map["WSegSpace"] = "WSEGSPACE"
	map["ZWJ"] = "ZWJ"
}

/^[^#]/ {
	n = split($1, a, /\.\./)
	lo = strtonum("0X" a[1])
	hi = strtonum("0X" a[n])

	for (i = lo; i <= hi; i++)
		props[i] = map[$2]
}

END {
	for (i = 0; i <= 0xFF; i++)
		printf "%12s,\n", "WB_" (props[i] ? props[i] : "XX")
}
' /tmp/librune/rtype/WordBreakProperty.txt \
| paste -d' ' - - - - - - - - \
| sed 's/^/\t/'

cat <<C
};

static const struct {
	rune lo, hi;
	rprop_wb_bf val;
} rtype_wb_tbl[] = {
C

gawk '
BEGIN {
	FS = "( *#.*| +; +)"
	map["CR"] = "CR"
	map["Double_Quote"] = "DQ"
	map["E_Base"] = "EB"
	map["E_Base_GAZ"] = "EBG"
	map["E_Modifier"] = "EM"
	map["ExtendNumLet"] = "EX"
	map["Extend"] = "EXTEND"
	map["Format"] = "FO"
	map["Glue_After_Zwj"] = "GAZ"
	map["Hebrew_Letter"] = "HL"
	map["Katakana"] = "KA"
	map["ALetter"] = "LE"
	map["LF"] = "LF"
	map["MidNumLet"] = "MB"
	map["MidLetter"] = "ML"
	map["MidNum"] = "MN"
	map["Newline"] = "NL"
	map["Numeric"] = "NU"
	map["Regional_Indicator"] = "RI"
	map["Single_Quote"] = "SQ"
	map["WSegSpace"] = "WSEGSPACE"
	map["ZWJ"] = "ZWJ"
}

/^[^#]/ {
	n = split($1, a, /\.\./)
	lo = strtonum("0X" a[1])
	hi = strtonum("0X" a[n])

	for (i = lo; i <= hi; i++)
		props[i] = map[$2]
}

END {
	for (i = 0; i <= 0x10FFFF; i++) {
		if (!props[i])
			continue
		lo = i
		while (props[lo] == props[i + 1])
			i++
		printf "\t{RUNE_C(0x%06X), RUNE_C(0x%06X), WB_%s},\n", lo, i, props[lo]
	}
}
' /tmp/librune/rtype/WordBreakProperty.txt | sort

cat <<C
};

#endif /* !RUNE_INTERNAL_RTYPE_WB_H */
C
