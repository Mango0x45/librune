#!/bin/sh

cache()
{
	name="/tmp/librune/rtype/$(basename "$1")"
	if test ! -f "$name"
	then
		mkdir -p /tmp/librune/rtype
		wget -q "$1" -O "$name"
	fi
}

set -e
cd "${0%/*}/.."
exec >include/internal/rtype/nv.h

readonly URL='https://www.unicode.org/Public/UCD/latest/ucd/extracted/DerivedNumericValues.txt'
cache "$URL"

cat <<C
/* This file is autogenerated by gen/rtype-nv; DO NOT EDIT. */

#ifndef RUNE_INTERNAL_RTYPE_NV_H
#define RUNE_INTERNAL_RTYPE_NV_H

/* IWYU pragma: private */
/* clang-format off */

#include "../types.h"
#include "../../rtype.h"
#include "../../rune.h"

static const struct {
	rune key;
	double val;
} rtype_nv_tbl[] = {
C

gawk '
BEGIN {
	FS = "( *#.*| +; +)"
}

/^[^#]/ {
	n = split($1, a, /\.\./)
	lo = strtonum("0X" a[1])
	hi = strtonum("0X" a[n])

	for (i = lo; i <= hi; i++) {
		gsub(/^; /, "", $3)
		props[i] = "(double)" $3
	}
}

END {
	for (i = 0; i <= 0x10FFFF; i++) {
		if (!props[i])
			continue
		printf "\t{RUNE_C(0x%06X), %s},\n", i, props[i]
	}
}
' /tmp/librune/rtype/DerivedNumericValues.txt | sort

cat <<C
};

#endif /* !RUNE_INTERNAL_RTYPE_NV_H */
C
